<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Custom expectations</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Custom expectations</h1>



<p>This vignette shows you how to write your own expectations. Custom
expectations allow you to extend testthat to meet your own specialized
testing needs, creating new <code>expect_*</code> functions that work
exactly the same way as the built-ins. Custom expectations are
particularly useful if you want to produce expectations tailored for
domain-specific data structures, combine multiple checks into a single
expectation, or create more actionable feedback when an expectation
fails. You can use them within your package by putting them in a helper
file, or share them with others by exporting them from your package.</p>
<p>In this vignette, youâ€™ll learn about the three-part structure of
expectations, how to test your custom expectations, see a few examples,
and, if youâ€™re writing a lot of expectations, learn how to reduce
repeated code.</p>
<div id="do-you-need-it" class="section level2">
<h2>Do you need it?</h2>
<p>But before you read the rest of the vignette and dive into the full
details of creating a 100% correct expectation, consider if you can get
away with a simpler wrapper. If youâ€™re just customising an existing
expectation by changing some defaults, youâ€™re fine:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>expect_df <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">expect_s3_class</span>(tbl, <span class="st">&quot;data.frame&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>}</span></code></pre></div>
<p>If youâ€™re combining multiple expectations, you can introduce a subtle
problem. For example, take this expectation from tidytext:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># from tidytext</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>expect_nrow <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, n) {</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="fu">expect_s3_class</span>(tbl, <span class="st">&quot;data.frame&quot;</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">nrow</span>(tbl), n)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>}</span></code></pre></div>
<p>If we use it in a test you can see thereâ€™s an issue:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;success&quot;</span>, {</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="fu">expect_nrow</span>(mtcars, <span class="dv">32</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>})</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt; Test passed with 2 successes ğŸ‰.</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;failure 1&quot;</span>, {</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="fu">expect_nrow</span>(mtcars, <span class="dv">30</span>)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>})</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: failure 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt; Expected `nrow(tbl)` to equal `n`.</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt; Differences:</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt;   `actual`: 32.0</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt; `expected`: 30.0</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="co">#&gt; Backtrace:</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co">#&gt;     â–†</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co">#&gt;  1. â””â”€global expect_nrow(mtcars, 30)</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co">#&gt;  2.   â””â”€testthat::expect_equal(nrow(tbl), n)</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co">#&gt; ! Test failed with 1 failure and 1 success.</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;failure 2&quot;</span>, {</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  <span class="fu">expect_nrow</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>), <span class="dv">2</span>)</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>})</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: failure 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co">#&gt; Expected `tbl` to be an S3 object.</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="co">#&gt; Actual OO type: none.</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a><span class="co">#&gt; Backtrace:</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a><span class="co">#&gt;     â–†</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a><span class="co">#&gt;  1. â””â”€global expect_nrow(matrix(1:5), 2)</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a><span class="co">#&gt;  2.   â””â”€testthat::expect_s3_class(tbl, &quot;data.frame&quot;)</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: failure 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a><span class="co">#&gt; Expected `nrow(tbl)` to equal `n`.</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a><span class="co">#&gt; Differences:</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="co">#&gt;   `actual`: 5.0</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a><span class="co">#&gt; `expected`: 2.0</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a><span class="co">#&gt; Backtrace:</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a><span class="co">#&gt;     â–†</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a><span class="co">#&gt;  1. â””â”€global expect_nrow(matrix(1:5), 2)</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a><span class="co">#&gt;  2.   â””â”€testthat::expect_equal(nrow(tbl), n)</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a><span class="co">#&gt; ! Test failed with 2 failures and 0 successes.</span></span></code></pre></div>
<p>Each of these tests contain a single expectation, but they report a
total of two successes and failures. It would be confusing if testthat
didnâ€™t report these numbers correctly. But as a helper in your package,
itâ€™s probably not a big deal.</p>
<p>You might also notice that these failures generate a backtrace
whereas built-in expectations donâ€™t. Again, itâ€™s not a big deal because
the backtrace is correct, itâ€™s just not needed.</p>
<p>These are both minor issues, so if they donâ€™t bother you, you can
save yourself some pain by not reading this vignette ğŸ˜€.</p>
</div>
<div id="expectation-basics" class="section level2">
<h2>Expectation basics</h2>
<p>An expectation has four main parts, as illustrated by
<code>expect_length()</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>expect_length <span class="ot">&lt;-</span> <span class="cf">function</span>(object, n) {  </span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="co"># 1. Capture object and label</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  act <span class="ot">&lt;-</span> <span class="fu">quasi_label</span>(rlang<span class="sc">::</span><span class="fu">enquo</span>(object))</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  </span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  act_n <span class="ot">&lt;-</span> <span class="fu">length</span>(act<span class="sc">$</span>val)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="cf">if</span> (act_n <span class="sc">!=</span> n) {</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="co"># 2. Fail if expectations are violated</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    <span class="fu">fail</span>(<span class="fu">c</span>(</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to have length %i.&quot;</span>, act<span class="sc">$</span>lab, n),</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Actual length: %i.&quot;</span>, act_n)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    ))</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="co"># 3. Pass if expectations are met</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    <span class="fu">pass</span>()</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  }</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>  </span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  <span class="co"># 4. Invisibly return the input value</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  <span class="fu">invisible</span>(act<span class="sc">$</span>val)</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>}</span></code></pre></div>
<p>The first step in any expectation is to use
<code>quasi_label()</code> to capture a â€œlabeled valueâ€, i.e., a list
that contains both the value (<code>$val</code>) for testing and a label
(<code>$lab</code>) used to make failure messages as informative as
possible. This is a pattern that exists for fairly esoteric reasons; you
donâ€™t need to understand it, just copy and paste it.</p>
<p>Next you need to check each way that <code>object</code> could
violate the expectation. In this case, thereâ€™s only one check, but in
more complicated cases there can be many. Note the specific form of the
failure message: the first element describes what we expected, and then
the second line reports what we actually saw.</p>
<p>If the object is as expected, call <code>pass()</code>. This ensures
that a success will be registered in the test reporter.</p>
<p>Otherwise, call <code>fail()</code>. This ensures that a failure will
be registered in the test reporter. NB: unlike <code>stop()</code> or
<code>abort()</code>, <code>fail()</code> signals a failure but allows
code execution to continue, ensuring that one failure does not prevent
subsequent expectations from running.</p>
<p>Finally, return the input value (<code>act$val</code>) invisibly.
This is good practice because expectations are called primarily for
their side-effects (triggering a failure), and returning the value
allows expectations to be piped together:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;mtcars is a 13 row data frame&quot;</span>, {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  mtcars <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    <span class="fu">expect_type</span>(<span class="st">&quot;list&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    <span class="fu">expect_s3_class</span>(<span class="st">&quot;data.frame&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    <span class="fu">expect_length</span>(<span class="dv">11</span>)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>})</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">#&gt; Test passed with 3 successes ğŸŒˆ.</span></span></code></pre></div>
<div id="testing-your-expectations" class="section level3">
<h3>Testing your expectations</h3>
<p>Once youâ€™ve written your expectation, you need to test it:
expectations are functions that can have bugs, just like any other
function, and itâ€™s really important that they generate actionable
failure messages. Luckily testthat comes with three expectations
designed specifically to test expectations:</p>
<ul>
<li><code>expect_success()</code> checks that your expectation emits
exactly one success and zero failures.</li>
<li><code>expect_failure()</code> checks that your expectation emits
exactly one failure and zero successes.</li>
<li><code>expect_snapshot_failure()</code> captures the failure message
in a snapshot, making it easier to review whether itâ€™s useful.</li>
</ul>
<p>The first two expectations are particularly important because they
ensure that your expectation always reports either a single success or a
single failure. If it doesnâ€™t, the end user is going to get confusing
results in their test suite reports.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;expect_length works as expected&quot;</span>, {</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="fu">expect_success</span>(<span class="fu">expect_length</span>(x, <span class="dv">10</span>))</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="fu">expect_failure</span>(<span class="fu">expect_length</span>(x, <span class="dv">11</span>))</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>})</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt; Test passed with 2 successes ğŸ¥³.</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;expect_length gives useful feedback&quot;</span>, {</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>  <span class="fu">expect_snapshot_failure</span>(<span class="fu">expect_length</span>(x, <span class="dv">11</span>))</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>})</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Warning: expect_length gives useful feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">#&gt; Adding new snapshot:</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="co">#&gt; Code</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co">#&gt;   expect_length(x, 11)</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co">#&gt; Condition</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="co">#&gt;   Error:</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="co">#&gt;   ! Expected `x` to have length 11.</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="co">#&gt;   Actual length: 10.</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co">#&gt; Test passed with 1 success ğŸŠ.</span></span></code></pre></div>
</div>
</div>
<div id="examples" class="section level2">
<h2>Examples</h2>
<p>The following sections show you a few more variations, loosely based
on existing testthat expectations. These expectations were picked to
show how you can generate actionable failures in slightly more complex
situations.</p>
<div id="expect_vector_length" class="section level3">
<h3><code>expect_vector_length()</code></h3>
<p>Letâ€™s make <code>expect_length()</code> a bit more strict by also
checking that the input is a vector. R is a bit unusual in that it gives
a length to pretty much every object, and you can imagine not wanting
code like the following to succeed, because itâ€™s likely that the user
passed the wrong object to the test.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">expect_length</span>(mean, <span class="dv">1</span>)</span></code></pre></div>
<p>To do this weâ€™ll add an extra check that the input is either an
atomic vector or a list:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>expect_vector_length <span class="ot">&lt;-</span> <span class="cf">function</span>(object, n) {  </span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  act <span class="ot">&lt;-</span> <span class="fu">quasi_label</span>(rlang<span class="sc">::</span><span class="fu">enquo</span>(object))</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="co"># It&#39;s non-trivial to check if an object is a vector in base R so we</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="co"># use an rlang helper</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>rlang<span class="sc">::</span><span class="fu">is_vector</span>(act<span class="sc">$</span>val)) {</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    <span class="fu">fail</span>(<span class="fu">c</span>(</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to be a vector&quot;</span>, act<span class="sc">$</span>lab),</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Actual type: %s&quot;</span>, <span class="fu">typeof</span>(act<span class="sc">$</span>val))</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    ))</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    act_n <span class="ot">&lt;-</span> <span class="fu">length</span>(act<span class="sc">$</span>val)</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>    <span class="cf">if</span> (act_n <span class="sc">!=</span> n) {</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>      <span class="fu">fail</span>(<span class="fu">c</span>(</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to have length %i.&quot;</span>, act<span class="sc">$</span>lab, n),</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;Actual length: %i.&quot;</span>, act_n)</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>      ))</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>      <span class="fu">pass</span>()</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>    }</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>  }</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>  <span class="fu">invisible</span>(act<span class="sc">$</span>val)</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">expect_vector_length</span>(mean, <span class="dv">1</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">#&gt; Error: Expected `mean` to be a vector</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#&gt; Actual type: closure</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="fu">expect_vector_length</span>(mtcars, <span class="dv">15</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">#&gt; Error: Expected `mtcars` to have length 15.</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">#&gt; Actual length: 11.</span></span></code></pre></div>
</div>
<div id="expect_s3_class" class="section level3">
<h3><code>expect_s3_class()</code></h3>
<p>Or imagine youâ€™re checking to see if an object inherits from an S3
class. R has a lot of different OO systems, and you want your failure
messages to be as informative as possible, so before checking that the
class matches, you probably want to check that the object is from the
correct OO family.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>expect_s3_class <span class="ot">&lt;-</span> <span class="cf">function</span>(object, class) {</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>rlang<span class="sc">::</span><span class="fu">is_string</span>(class)) {</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    rlang<span class="sc">::</span><span class="fu">abort</span>(<span class="st">&quot;`class` must be a string.&quot;</span>)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  }</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  act <span class="ot">&lt;-</span> <span class="fu">quasi_label</span>(rlang<span class="sc">::</span><span class="fu">enquo</span>(object))</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.object</span>(act<span class="sc">$</span>val)) {</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="fu">fail</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to be an object.&quot;</span>, act<span class="sc">$</span>lab))</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">isS4</span>(act<span class="sc">$</span>val)) {</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="fu">fail</span>(<span class="fu">c</span>(</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to be an S3 object.&quot;</span>, act<span class="sc">$</span>lab),</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>      <span class="st">&quot;Actual OO type: S4&quot;</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    ))</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(act<span class="sc">$</span>val, class)) {</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="fu">fail</span>(<span class="fu">c</span>(</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to inherit from %s.&quot;</span>, act<span class="sc">$</span>lab, class),</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Actual class: %s&quot;</span>, <span class="fu">class</span>(act<span class="sc">$</span>val))</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    ))</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>    <span class="fu">pass</span>()</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>  }</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>  <span class="fu">invisible</span>(act<span class="sc">$</span>val)</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>TestClass <span class="ot">&lt;-</span> methods<span class="sc">::</span><span class="fu">setClass</span>(<span class="st">&quot;Test&quot;</span>, <span class="at">contains =</span> <span class="st">&quot;integer&quot;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">TestClass</span>()</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>x3 <span class="ot">&lt;-</span> <span class="fu">factor</span>()</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="fu">expect_s3_class</span>(x1, <span class="st">&quot;integer&quot;</span>)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co">#&gt; Error: Expected `x1` to be an object.</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="fu">expect_s3_class</span>(x2, <span class="st">&quot;integer&quot;</span>)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">#&gt; Error: Expected `x2` to be an S3 object.</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">#&gt; Actual OO type: S4</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="fu">expect_s3_class</span>(x3, <span class="st">&quot;integer&quot;</span>)</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">#&gt; Error: Expected `x3` to inherit from integer.</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co">#&gt; Actual class: factor</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="fu">expect_s3_class</span>(x3, <span class="st">&quot;factor&quot;</span>)</span></code></pre></div>
<p>Note the variety of error messages. We always print what was
expected, and where possible, also display what was actually
received:</p>
<ul>
<li>When <code>object</code> isnâ€™t an object, we can only say what we
expected.</li>
<li>When <code>object</code> is an S4 object, we can report that.</li>
<li>When <code>inherits()</code> is <code>FALSE</code>, we provide the
actual class, since thatâ€™s most informative.</li>
</ul>
<p>The general principle is to tailor error messages to what the user
can act on based on what you know about the input.</p>
<p>Also note that I check that the <code>class</code> argument is a
string. If itâ€™s not a string, I throw an error. This is not a test
failure; the user is calling the function incorrectly. In general, you
should check the type of all arguments that affect the operation and
error if theyâ€™re not what you expect.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">expect_s3_class</span>(x1, <span class="dv">1</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">#&gt; Error in `expect_s3_class()`:</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">#&gt; ! `class` must be a string.</span></span></code></pre></div>
</div>
<div id="optional-class" class="section level3">
<h3>Optional <code>class</code></h3>
<p>A common pattern in testthatâ€™s own expectations it to use arguments
to control the level of detail in the test. Here it would be nice if we
check that an object is an S3 object without checking for a specific
class. I think we could do that by renaming
<code>expect_s3_class()</code> to <code>expect_s3_object()</code>. Now
<code>expect_s3_object(x)</code> would verify that <code>x</code> is an
S3 object, and <code>expect_s3_object(x, class = &quot;foo&quot;)</code> to verify
that <code>x</code> is an S3 object with the given class. The
implementation of this is straightforward: we also allow
<code>class</code> to be <code>NULL</code> and then only verify
inheritance when non-<code>NULL</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>expect_s3_object <span class="ot">&lt;-</span> <span class="cf">function</span>(object, <span class="at">class =</span> <span class="cn">NULL</span>) {</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>rlang<span class="sc">::</span><span class="fu">is_string</span>(class) <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(class)) {</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>    rlang<span class="sc">::</span><span class="fu">abort</span>(<span class="st">&quot;`class` must be a string or NULL.&quot;</span>)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  }</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  act <span class="ot">&lt;-</span> <span class="fu">quasi_label</span>(rlang<span class="sc">::</span><span class="fu">enquo</span>(object))</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.object</span>(act<span class="sc">$</span>val)) {</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="fu">fail</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to be an object.&quot;</span>, act<span class="sc">$</span>lab))</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">isS4</span>(act<span class="sc">$</span>val)) {</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>    <span class="fu">fail</span>(<span class="fu">c</span>(</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to be an S3 object.&quot;</span>, act<span class="sc">$</span>lab),</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>      <span class="st">&quot;Actual OO type: S4&quot;</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    ))</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(class) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">inherits</span>(act<span class="sc">$</span>val, class)) {</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>    <span class="fu">fail</span>(<span class="fu">c</span>(</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Expected %s to inherit from %s.&quot;</span>, act<span class="sc">$</span>lab, class),</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;Actual class: %s&quot;</span>, <span class="fu">class</span>(act<span class="sc">$</span>val))</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>    ))</span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>    <span class="fu">pass</span>()</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>  }</span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>  <span class="fu">invisible</span>(act<span class="sc">$</span>val)</span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="repeated-code" class="section level2">
<h2>Repeated code</h2>
<p>As you write more expectations, you might discover repeated code that
you want to extract into a helper. Unfortunately, creating 100% correct
helper functions is not straightforward in testthat because
<code>fail()</code> captures the calling environment in order to give
useful tracebacks, and testthatâ€™s own expectations donâ€™t expose this as
an argument. Fortunately, getting this right is not critical (youâ€™ll
just get a slightly suboptimal traceback in the case of failure), so we
donâ€™t recommend bothering in most cases. We document it here, however,
because itâ€™s important to get it right in testthat itself.</p>
<p>The key challenge is that <code>fail()</code> captures a
<code>trace_env</code>, which should be the execution environment of the
expectation. This usually works because the default value of
<code>trace_env</code> is <code>rlang::caller_env()</code>. But when you
introduce a helper, youâ€™ll need to explicitly pass it along:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>expect_length_ <span class="ot">&lt;-</span> <span class="cf">function</span>(act, n, <span class="at">trace_env =</span> <span class="fu">caller_env</span>()) {</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  act_n <span class="ot">&lt;-</span> <span class="fu">length</span>(act<span class="sc">$</span>val)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="cf">if</span> (act_n <span class="sc">!=</span> n) {</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    <span class="fu">fail</span>(</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">&quot;%s has length %i, not length %i.&quot;</span>, act<span class="sc">$</span>lab, act_n, n), </span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>      <span class="at">trace_env =</span> trace_env</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>    )</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>    <span class="fu">pass</span>()</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  }</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>}</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>expect_length <span class="ot">&lt;-</span> <span class="cf">function</span>(object, n) {  </span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  act <span class="ot">&lt;-</span> <span class="fu">quasi_label</span>(rlang<span class="sc">::</span><span class="fu">enquo</span>(object))</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  <span class="fu">expect_length_</span>(act, n)</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>  <span class="fu">invisible</span>(act<span class="sc">$</span>val)</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>}</span></code></pre></div>
<p>A few recommendations:</p>
<ul>
<li>The helper shouldnâ€™t be user-facing, so we give it a <code>_</code>
suffix to make that clear.</li>
<li>Itâ€™s typically easiest for a helper to take the labeled value
produced by <code>quasi_label()</code>.</li>
<li>Your helper should usually be called for its side effects (i.e.Â it
calls <code>fail()</code> and <code>pass()</code>).</li>
<li>You should return <code>invisible(act$val)</code> from the parent
expecatation as usual.</li>
</ul>
<p>Again, youâ€™re probably not writing so many expectations that it makes
sense for you to go to this effort, but it is important for testthat to
get it right.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
