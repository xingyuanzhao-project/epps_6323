name: Quarto Publish

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install required R packages
        run: |
          set -o pipefail
          Rscript - <<'RS' 2>&1 | tee r-packages-install.log
          req_file <- "requirements-r.txt"
          if (!file.exists(req_file)) {
            stop("Missing requirements file: ", req_file)
          }

          pkgs <- readLines(req_file, warn = FALSE)
          pkgs <- trimws(pkgs)
          pkgs <- pkgs[nzchar(pkgs) & !grepl("^#", pkgs)]

          missing <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
          if (length(missing) > 0) {
            install.packages(missing, repos = "https://cloud.r-project.org")
          }

          unresolved <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
          if (length(unresolved) > 0) {
            stop("Packages failed to install: ", paste(unresolved, collapse = ", "))
          }

          versions <- vapply(pkgs, function(pkg) as.character(packageVersion(pkg)), character(1))
          print(versions)
          RS

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Render Quarto Project
        run: |
          set -o pipefail
          quarto render --log quarto-render.log --log-level info --log-format plain 2>&1 | tee render-console.log

      - name: Upload render logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quarto-render-logs
          if-no-files-found: warn
          path: |
            r-packages-install.log
            quarto-render.log
            render-console.log

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
